<div class="container mt-5">
  <h2 class="text-center mb-4">Purchase a Package</h2>

  <div class="row justify-content-center">
    <div class="col-md-6">
      <%= form_with url: purchases_path, class: "needs-validation", scope: :purchase, data: { turbo: false } do |form| %>
        <div class="form-group mb-3">
          <%= form.label :first_name, "First Name", class: "form-label" %>
          <%= form.text_field :first_name, class: "form-control", required: true %>
        </div>

        <div class="form-group mb-3">
          <%= form.label :last_name, "Last Name", class: "form-label" %>
          <%= form.text_field :last_name, class: "form-control", required: true %>
        </div>

        <div class="form-group mb-3">
          <%= form.label :email, "Email", class: "form-label" %>
          <%= form.email_field :email, class: "form-control", required: true %>
        </div>
        <div class="form-group mb-3">
          <%= form.label :package_id, "Select Package", class: "form-label" %>
          <%= form.select :package_id, options_from_collection_for_select(@packages, :id, :name), { include_blank: true }, class: "form-select", required: true %>
        </div>

        <div class="form-group mb-3">
          <label for="card-element" class="form-label">Credit or Debit Card</label>
          <div id="card-element" class="form-control"></div>
        </div>

        <%= form.hidden_field :payment_method_id %>

        <div class="d-grid">
          <button type="submit" class="btn btn-primary btn-block">Purchase</button>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const stripe = Stripe("<%= ENV['STRIPE_PUBLISHABLE_KEY'] %>");
    const elements = stripe.elements();
    const cardElement = elements.create('card');
    cardElement.mount('#card-element');

    const form = document.querySelector('form');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const { paymentMethod, error } = await stripe.createPaymentMethod('card', cardElement);

      if (error) {
        alert(error.message);
      } else {
        form.querySelector('input[name="purchase[payment_method_id]"]').value = paymentMethod.id;
        form.submit();
      }
    });
  });
</script>
