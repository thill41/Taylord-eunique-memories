# /etc/nginx/sites-available/euniquememories.com
# Rails application
upstream puma {
  server unix:///home/deploy/tem/shared/tmp/sockets/tem-puma.sock;
}

#server {
  #  server_name www.euniquememories.com euniquememories.com;

 #   root /var/www/html;
 #   index index.html index.htm;

 #   location /.well-known/acme-challenge/ {
 #       root /var/www/html;
 #       try_files $uri =404;
 #       allow all;
 #   }

#    location / {
#        try_files $uri $uri/ =404;
#    }

    #listen 443 ssl; # managed by Certbot
    #ssl_certificate /etc/letsencrypt/live/euniquememories.com/fullchain.pem; # managed by Certbot
    #ssl_certificate_key /etc/letsencrypt/live/euniquememories.com/privkey.pem; # managed by Certbot
    #include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    #ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

#}

server {
    listen 443 ssl http2;
    server_name www.euniquememories.com euniquememories.com;

    index index.html index.htm;

    location /.well-known/acme-challenge/ {
        root /var/www/html;
        try_files $uri =404;
        allow all;
    }

    ssl_certificate /etc/letsencrypt/live/euniquememories.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/euniquememories.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbo

    # Improve SSL configuration

    #ssl_protocols TLSv1.2 TLSv1.3;
    #ssl_prefer_server_ciphers on;
    #ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-
AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_session_cache shared:SSL:10m;
    #ssl_session_timeout 10m;
    ssl_stapling on;
    ssl_stapling_verify on;

    root /home/deploy/tem/current/public;

    # Add security headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    location ^~ /assets/ {
        gzip_static on;
        expires max;
        add_header Cache-Control public;
    }

     # NGINX serves static files directly from the public folder
     location / {
       try_files $uri/index.html $uri @puma;
     }

     location @puma {
      proxy_pass http://127.0.0.1:3000; # See puma config in rails app for the port it listens on
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Error pages
    error_page 500 502 503 504 /500.html;
    client_max_body_size 10M;
    keepalive_timeout 10;

    # Log files
    access_log /var/log/nginx/tem_nginx_access.log;
    error_log /var/log/nginx/tem_nginx_error.log;
}


server {
    if ($host = euniquememories.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    listen 80;
    server_name www.euniquememories.com euniquememories.com;
    return 404; # managed by Certbot


}